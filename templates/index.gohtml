<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-title" content="Also, see">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>{{ title .Breadcrumbs }}</title>
    <link rel="stylesheet" href="/style.css?crc={{ crc32 "style.css" }}">
    <script src="https://unpkg.com/htmx.org@1.9.4" integrity="sha384-zUfuhFKKZCbHTY6aRR46gxiqszMk5tcHjsVFxnUo8VMus4kHGVdIYVbOYYNlKmHV" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css">
    <link rel="apple-touch-icon" href="/favicon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon_192r.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon_512r.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <script src="/meilisearch.umd.js"></script>
</head>
<body data-view="columns">
<div id="toolbar" hx-preserve="true">
    <div id="logo"><a href="/"></a></div>
    <label id="searchWrapper">
        <input id="search" type="search" role="searchbox" placeholder="Search" oninput="search(event)" autocomplete="off">
    </label>
    <fieldset
        class="radio menubar-navigation"
        title="Show items as icons, in a list or in columns"
        role="menubar"
        aria-label="View"
    >
        <legend>View</legend>
        <label tabindex="0" role="menuitem"><input type="radio" name="view" value="icons"> <span>Icons</span></label>
        <label tabindex="0" role="menuitem"><input type="radio" name="view" value="list"> <span>List</span></label>
        <label tabindex="0" role="menuitem"><input type="radio" name="view" value="columns" checked> <span>Columns</span></label>
    </fieldset>
</div>
<nav>
    <ul id="breadcrumbs" class="menubar-navigation" role="menubar" aria-label="breadcrumbs">
        {{- range .Breadcrumbs }}
        {{- $slash := "/" }}
        {{- if eq .Path "" }}
        {{- $slash = "" }}
        {{- end }}
        {{- $isCurrent := eq $.CurrentPath .Path }}
        {{- if $isCurrent }}
        <li role="none"><span>
            {{- if and $.Content $.Content.Name }}
                {{- $.Content.Name }}
            {{- else }}
                {{- .Name }}
            {{- end -}}
        </span></li>
        {{- else }}
        <li role="none"><a role="menuitem" href="/{{ .Path }}{{ $slash }}">{{ .Name }}</a></li>
        {{- end }}
        {{- end }}
    </ul>
</nav>
<div id="container" hx-boost="true">
    <nav id="panels">
    {{- range $index, $panel := .Panels }}
        <ul class="panel menubar-navigation" role="menu" data-level="{{ $index }}"
            {{- if and (not $.Content) (isLast $index (len $.Panels)) }} id="_"{{ end }}>
            {{- range $panel.Files }}
            {{- $path := join $panel.Dir .Name }}
            <li role="none">
                <a
                    role="menuitem"
                    {{- if .Image }}style="--background-image: url('https://media.alsosee.info/{{ $panel.Dir }}/{{ .Image.ThumbPath }}'); {{ thumbStylePx .Image 100 "--" }}; {{ thumbStylePx .Image 24 "--small-" }}"{{ end }}
                    class="{{ if .IsFolder }}folder{{ if hasPrefix $.CurrentPath $path }} in-path{{ end }}{{ end }}{{ if eq $.CurrentPath $path }} active{{ end }}{{ if .Image }} has-image{{ if isJPG .Image.Path }} jpg{{end}}{{- if hasPrefix $.CurrentPath "People" }} people{{ end }}{{ end }}"
                    href="/{{ $path }}{{ if .IsFolder }}/{{ end }}"
                >
                    <span>{{ .Title }}</span>
                </a>
            </li>
            {{- end }}
        </ul>
    {{- end }}
    {{ with .Content }}
        <div class="content">
            {{ with .HTML }}{{ . }}{{ end }}
            {{ with .Image }}
                {{- $div := 3 }}
                {{- if hasPrefix $.CurrentPath "Movies" }}
                    {{- $div = 2 }}
                {{- end }}
                <div class="thumb{{ if isJPG .Path }} jpg{{end}}{{- if hasPrefix $.CurrentPath "People" }} people{{ end }}"
                    style="background-image: url('https://media.alsosee.info/{{ $.Dir }}/{{ .ThumbPath }}');
                        {{- thumbStylePct . -}}
                    ">
                </div>
            {{ end }}
            {{ if .Name }}<h1{{ if .Subtitle }} class="with-subtitle"{{ end }}>{{ .Name }}</h1>{{ end }}
            {{ with .Subtitle }}<p class="subtitle">{{ . }}</p>{{ end }}
            {{ if .Series }}<p class="series">Series: {{ template "reference" dict "Path" (series .) "HideType" true }}</p>{{ end }}
            {{- if either .Genres .Rating .Length }}
            <p class="labels">
            {{- with .Genres }}{{ range . }}<span class="genre">{{ . }}</span>{{ end }}{{ end }}
            {{- if .Rating }}<span class="rating">{{ .Rating }}</span>{{ end }}
            {{- if .Length }}<span class="length">{{ length .Length }}</span>{{ end }}
            </p>
            {{- end }}
            {{ with .Description }}<p>{{ . }}</p>{{ end }}
            {{ with .DOB }}<p>Born: {{ . }}</p>{{ end }}
            {{ with .DOD }}<p>Died: {{ . }}</p>{{ end }}
            {{ with .Developers }}<p>Developers: {{ . }}</p>{{ end }}
            {{ with .Author }}<p>Author: {{ template "person" . }}</p>{{ end }}
            {{ with .Authors }}<p>Authors:
            {{ range . }}
                <span class="list">{{ template "person" . }}</span>
            {{ end }}
            {{ end }}
            {{ with .Website}}<p><a href="{{ . }}">{{ . }}</a></p>{{ end }}
            {{ with .Websites }}{{ range . }}
                <p><a href="{{ . }}">{{ . }}</a></p>
            {{ end }}{{ end }}
            {{ with .Designer }}<p>Designer: {{ template "person" . }}</p>{{ end }}

            {{ with .BasedOn }}
            <p>Based on
            {{ range . }}
                <span class="list">{{ template "reference" dict "Path" . "HideType" true}}</span>
            {{ end }}
            </p>
            {{ end }}

            {{ with .Directors }}<p>Directors:
            {{ range . }}
                <span class="list">{{ template "person" . }}</span>
            {{ end }}
            </p>
            {{ end }}

            {{ with .Cinematography }}<p>Cinematography: {{ template "person" . }}</p>{{ end }}
            {{ with .Editor }}<p>Editor: {{ template "person" . }}</p>{{ end }}
            {{ with .Music }}<p>Music: {{ template "person" . }}</p>{{ end }}
            {{ with .Artists }}<p>Artists:
            {{ range . }}
                <span class="list">{{ template "person" . }}</span>
            {{ end }}
            </p>
            {{ end }}
            {{ with .Colorist }}<p>Colorist: {{ template "person" . }}</p>{{ end }}

            {{ with .Producers }}
            <p>Producers:
            {{ range . }}
                <span class="list">{{ template "person" . }}</span>
            {{ end }}
            </p>
            {{ end }}

            {{ with .Production }}
            <p>Production:
            {{ range . }}
                <span class="list">{{ template "person" . }}</span>
            {{ end }}
            </p>
            {{ end }}

            {{ with .Distributor }}<p>Distributer: {{ . }}</p>{{ end }}

            {{ with .Writers }}
            <p>Writers:
            {{ range . }}
                <span class="list">{{ template "person" . }}</span>
            {{ end }}
            </p>
            {{ end }}

            {{ with .Publisher }}<p>Publisher: {{ . }}</p>{{ end }}
            {{ with .Publication }}<p>Publication: {{ . }}</p>{{ end }}
            {{ with .CoverArtist }}<p>Cover Artist: {{ template "person" . }}</p>{{ end }}
            {{ with .ISBN }}<p>ISBN: {{ . }}</p>{{ end }}
            {{ with .ISBN10 }}<p>ISBN10: {{ . }}</p>{{ end }}
            {{ with .ISBN13 }}<p>ISBN13: {{ . }}</p>{{ end }}
            {{ with .UPC }}<p>UPC: {{ . }}</p>{{ end }}

            <p class="links">
                {{ with .Contact }}<a href="{{ . }}">Contact</a>{{ end }}
                {{ with .Trailer }}<a href="{{ . }}">Trailer</a>{{ end }}
                {{ with .Wikipedia }}<a href="{{ . }}">Wikipedia</a>{{ end }}
                {{ with .IMDB }}<a href="{{ . }}">IMDB</a>{{ end }}
                {{ with .TMDB }}<a href="{{ . }}">TMDB</a>{{ end }}
                {{ with .GoodReads }}<a href="{{ . }}">GoodReads</a>{{ end }}
                {{ with .Bookshop }}<a href="{{ . }}">Bookshop</a>{{ end }}
                {{ with .RottenTomatoes }}<a href="{{ . }}">Rotten Tomatoes</a>{{ end }}
                {{ with .AppStore }}<a href="{{ . }}">App Store</a>{{ end }}
                {{ with .Twitch }}<a href="{{ . }}">Twitch</a>{{ end }}
                {{ with .YouTube }}<a href="{{ . }}">YouTube</a>{{ end }}
                {{ with .Reddit }}<a href="{{ . }}">Reddit</a>{{ end }}
                {{ with .X }}<a href="{{ . }}">X</a>{{ end }}
                {{ with .Twitter }}<a href="{{ . }}">X</a>{{ end }}
                {{ with .Facebook }}<a href="{{ . }}">Facebook</a>{{ end }}
                {{ with .Instagram }}<a href="{{ . }}">Instagram</a>{{ end }}
                {{ with .TikTok }}<a href="{{ . }}">TikTok</a>{{ end }}
                {{ with .Netflix }}<a href="{{ . }}">Netflix</a>{{ end }}
                {{ with .Spotify }}<a href="{{ . }}">Spotify</a>{{ end }}
                {{ with .Soundcloud }}<a href="{{ . }}">Soundcloud</a>{{ end }}
                {{ with .Hulu }}<a href="{{ . }}">Hulu</a>{{ end }}
                {{ with .AdultSwim }}<a href="{{ . }}">AdultSwim</a>{{ end }}
                {{ with .Fandom }}<a href="{{ . }}">Fandom</a>{{ end }}
                {{ with .TelegramChannel }}<a href="{{ . }}">Telegram channel</a>{{ end }}
                {{ with .Steam }}<a href="{{ . }}">Steam</a>{{ end }}
                {{ with .PlayStation }}<a href="{{ . }}">PlayStation</a>{{ end }}
                {{ with .XBox }}<a href="{{ . }}">XBox</a>{{ end }}
                {{ with .GOG }}<a href="{{ . }}">GOG</a>{{ end }}
                {{ with .Epic }}<a href="{{ . }}">Epic</a>{{ end }}
                {{ with .Discord }}<a href="{{ . }}">Discord</a>{{ end }}
                {{ with .IGN }}<a href="{{ . }}">IGN</a>{{ end }}
                {{ with .Amazon }}<a href="{{ . }}">Amazon</a>{{ end }}
                {{ with .AppleTV }}<a href="{{ . }}">AppleTV</a>{{ end }}
                {{ with .GooglePlay }}<a href="{{ . }}">GooglePlay</a>{{ end }}
                {{ with .MicrosoftStore }}<a href="{{ . }}">Microsoft Store</a>{{ end }}
                {{ with .Row8 }}<a href="{{ . }}">Row8</a>{{ end }}
                {{ with .Redbox }}<a href="{{ . }}">Redbox</a>{{ end }}
                {{ with .Vudu }}<a href="{{ . }}">Vudu</a>{{ end }}
            </p>

            {{ with .Characters }}
            <h2>Characters</h2>
            <ul class="characters">
                {{ range . }}
                    <li>
                        {{ if .Image }}
                        <span class="image drop" style="background-image: url('https://media.alsosee.info/{{ escape $.CurrentPath }}/Characters/{{ .Image.ThumbPath }}'); {{ thumbStylePct .Image }}"></span>
                        {{ else }}
                        <span class="initials drop">{{ initials .Actor }}</span>
                        {{ end }}
                        <span class="name">{{ .Name }}</span>
                        {{ if .Actor }}
                            {{- $person := content (join "People/" .Actor) }}
                            {{- if $person }}
                            <a class="actor" href="/People/{{ .Actor }}">{{ .Actor }}</a>
                            {{- else }}
                            <span class="actor">{{ .Actor }}</span>
                            {{- end }}
                        {{- else if .Voice }}
                            {{- $person := content (join "People/" .Voice) }}
                            {{- if $person }}
                            <a class="actor" href="/People/{{ .Voice }}">{{ .Voice }}</a>
                            {{- else }}
                            <span class="actor">{{ .Voice }}</span>
                            {{- end }}
                        {{- end }}
                    </li>
                {{ end }}
            </ul>
            {{ end }}

            {{ with connections $.CurrentPath }}
            <h2>Connections</h2>
            <ul class="connections flat">
                {{ template "connections" . }}
            </ul>
            {{ end }}

            {{ with .References }}
            <h2>Also, see</h2>
            <ul class="connections flat">
                {{- range . }}
                <li>{{ template "reference" dict "Path" .Path }}</li>
                {{- end }}
            </ul>
            {{ end }}

            {{ with .Extra }}
                {{ range $key, $value := . }}
                    <p>{{ $key }}: {{ $value }}</p>
                {{ end }}
            {{ end }}
        </div>
        <div id="_"></div>
    {{ end }}
    </nav>
</div>
<div id="backdrop" style="display: none"></div>
<div id="uploader" style="display: none">
    <h1 id="uploader_target"></h1>
    <div id="uploader_preview"></div>
    <div class="buttons">
      <button class="dismiss" onclick="uploader_cancel()">Cancel</button>
      <button class="primary" onclick="uploader_upload()">Upload</button>
    </div>
</div>
<script type="text/javascript">
if (typeof hasRun === 'undefined') {
    document.getElementById("_").scrollIntoView();

    var viewSwitcher = document.querySelector('#toolbar fieldset');
    var container = document.querySelector('#container');
    var breakcrumbs = document.querySelector('#breakcrumbs');
    var panels = document.querySelector('#panels');
    var searchInput = document.querySelector('#search');

    var backdrop = document.querySelector('#backdrop');
    var uploader = document.querySelector('#uploader');
    var uploader_target = document.querySelector('#uploader_target');
    var uploader_preview = document.querySelector('#uploader_preview');

    var view = localStorage.getItem('view') || 'icons';
    if (view != 'icons' && view != 'list' && view != 'columns') {
        view = 'icons';
    }
    document.body.setAttribute('data-view', view);
    viewSwitcher.querySelector(`input[value=${view}]`).checked = true;

    var setView = function(value) {
        localStorage.setItem('view', value);
        document.body.setAttribute('data-view', value);
        document.getElementById("_").scrollIntoView();
    };

    // if enter or space is pressed on a toolbar item, check the radio button
    viewSwitcher.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
            event.target.querySelector('input').checked = true;
            setView(event.target.querySelector('input').value);
        }
    });

    viewSwitcher.addEventListener('change', (event) => {
        setView(event.target.value);
    });

    htmx.on('htmx:afterSwap', function(evt) {
        document.getElementById("_").scrollIntoView();
    });

    /* search */
    var client = new MeiliSearch({
        host: "{{ config "SearchHost" }}",
        apiKey: "{{ config "SearchAPIKey" }}",
    });

    function thumbStylePx(media, max, prefix) {
        if (!media) {
            return "";
        }

        var backgroundWidth = media.ThumbTotalWidth * max / media.ThumbWidth;
        var backgroundHeight = media.ThumbTotalHeight * max / media.ThumbWidth;
        var positionX = (media.ThumbXOffset || 0) * max / media.ThumbWidth;
        var positionY = (media.ThumbYOffset || 0) * max / media.ThumbWidth;
        var width = max;
        var height = media.ThumbHeight * max / media.ThumbWidth;

        if (media.Height > media.Width) {
          backgroundWidth = media.ThumbTotalWidth * max / media.ThumbHeight;
          backgroundHeight = media.ThumbTotalHeight * max / media.ThumbHeight;
          positionX = (media.ThumbXOffset || 0) * max / media.ThumbHeight;
          positionY = (media.ThumbYOffset || 0) * max / media.ThumbHeight;
          width = media.ThumbWidth * max / media.ThumbHeight;
          height = max;
        }

        var marginLeft = (max - width) / 2;
        var marginRight = max - width - marginLeft;

        var style = `${prefix}background-size: ${backgroundWidth.toFixed(2)}px ${backgroundHeight.toFixed(2)}px; ${prefix}width: ${width.toFixed(2)}px; ${prefix}height: ${height.toFixed(2)}px; ${prefix}comp-margin-left: ${marginLeft.toFixed(2)}px; ${prefix}comp-margin-right: ${marginRight.toFixed(2)}px`;

        if (positionX != 0 || positionY != 0) {
          style += `; ${prefix}background-position: -${positionX.toFixed(2)}px -${positionY.toFixed(2)}px`;
        }

        return style;
    }

    /* Because search naviration is not a real navigation,
     * we need to backup the state of the page
     * before search, and restore it after search is cleared */
    var titleBackup = "";
    var breadcrumbsBackup;
    var panelsBackup = "";
    var previousQuery = "";
    var urlBackup = "";

    function search(event, pushState = true) {
        var query = event.target.value || "";
        if (query.length == 0) {
            // query is cleared, restore the original state
            if (breadcrumbsBackup) {
                breadcrumbs.innerHTML = breadcrumbsBackup;
                breadcrumbsBackup = "";
            }
            if (panelsBackup) {
                panels.innerHTML = panelsBackup;
                panelsBackup = "";
            }
            if (titleBackup) {
                document.title = titleBackup;
                titleBackup = "";
            }
            previousQuery = "";
            console.log("Restoring original state", urlBackup, titleBackup);
            if (urlBackup.length == 0) {
                // a corner case when page is loaded with a query, and then the query is cleared
                console.log("Navigating to home");
                logo.querySelector("a").click();
                return;
            }
            if (pushState) {
                console.log("Pushing state", urlBackup);
                history.pushState({}, "", urlBackup);
                urlBackup = "";
            }
            return;
        }
        if (previousQuery.length == 0) {
            // previous query was empty, save the state
            breadcrumbsBackup = breadcrumbs.innerHTML;
            panelsBackup = panels.innerHTML;
            urlBackup = window.location.href;
            titleBackup = document.title;
            console.log("Saving original state", window.location.href);
        }

        // push history update and change URL
        if (pushState) {
            console.log("Pushing state", query);
            history.pushState({query: query}, "", "/search?q=" + encodeURIComponent(query));
            document.title = "Search: " + query;
        }

        breadcrumbs.innerHTML = `<li role="none"><a role="menuitem" href="/">Home</a></li><li role="none"><span>Search: ${query}</span></li>`;
        if (previousQuery.length == 0) {
            panels.innerHTML = `<ul class="panel menubar-navigation" role="menu" data-level="0" id="_"></ul>`;
        }

        console.log("Setting previousQuery to", query);
        previousQuery = query;

        client.index("info").search(query, {limit: 100}).then((response) => {
            // if the query has changed, ignore the response
            if (previousQuery != query) {
                return;
            }

            const results = response.hits.map(function(hit) {
                const path = hit.Source.substring(0, hit.Source.lastIndexOf('.'))
                const dir = path.substring(0, path.lastIndexOf('/'));
                var attr = "";
                if (hit.Image) {
                    const ext = hit.Image.Path.substring(hit.Image.Path.lastIndexOf('.') + 1)
                    var linkClass = "has-image";
                    if (ext == "jpg" || ext == "jpeg") {
                        linkClass += " jpg";
                    }

                    attr = `style="--background-image: url('https://media.alsosee.info/${dir}/${hit.Image.ThumbPath}'); ${thumbStylePx(hit.Image, 100, "--")}; ${thumbStylePx(hit.Image, 24, "--small-")}" class="${linkClass}"`;
                }
                return {
                    name: hit.Name,
                    href: path,
                    attr: attr,
                };
            });

            const resultsHTML = results.map(function(result) {
                return `<li role="none">
                    <a role="menuitem" ${result.attr} href="/${result.href}">
                        <span>${result.name}</span>
                    </a>
                </li>`;
            }).join("");

            panels.innerHTML = `<ul class="panel menubar-navigation" role="menu" data-level="0" id="_">${resultsHTML}</ul>`;
        });
    }
    // restore the search query if the user navigates back
    window.addEventListener('popstate', function(event) {
        console.log("Popstate", event.state, "URL", window.location.href);
        var query = "";
        if (event.state !== null && event.state.query !== undefined) {
            // if (event.state.htmx === true && previousQuery.length > 0) {
                // this is a weird case when the user navigates back to the empty
                // search
                // return;
            // }
            query = event.state.query;
            document.title = "Search: " + query;
            search({target: {value: query}}, false);
            searchInput.value = query;
        }

        if (event.state == null) {
            // check, maybe there is a query in the URL
            if (window.location.pathname.startsWith("/search")) {
                const url = new URL(window.location.href);
                query = url.searchParams.get("q");
                document.title = "Search: " + query;
                search({target: {value: query}}, false);
                searchInput.value = query;
                return;
            }

            // return to empty search state
            search({target: {value: ""}}, false);
            searchInput.value = "";
        }
    });
    // on page load, restore the search query if there is one
    window.addEventListener('load', function(event) {
        const url = new URL(window.location.href);
        const query = url.searchParams.get("q");
        if (query) {
            previousQuery = query; // bugfix for cases where the user navigates back to the empty search from a page that was loaded directly with a search query
            search({target: {value: query}}, false);
            document.title = "Search: " + query;
            searchInput.value = query;
        }
    });

    /* handle drag and drop */
    var c = null; /* croppie instance */

    function extension(mime) {
        switch (mime) {
        case "image/jpeg":
            return ".jpg";
        case "image/png":
            return ".png";
        case "image/gif":
            return ".gif";
        default:
            return "";
        }
    }

    function download(binary, mime) {
        const a = document.createElement('a');
        a.href = 'data:' + mime + ';base64,' + btoa(binary);
        a.download = uploader.dataset.target;
        a.click();
    }

    function uploader_cancel() {
        backdrop.style.display = 'none';
        uploader.style.display = 'none';
        c.destroy();
    }

    function uploader_upload() {
        c.result({
            type: 'blob',
            size: 'viewport'
        }).then(function(blob) {
            Jimp.read(c.data.url).then(function(image) {
                const points = c.get()["points"].map(function(p) {
                    return parseInt(p);
                });
                image
                    .crop(
                        points[0],
                        points[1],
                        points[2] - points[0],
                        points[3] - points[1]
                    )
                    .quality(85)
                    .getBuffer(Jimp.MIME_JPEG, function(err, buffer) {

                    {{/* download(binary, image.getMIME()); */}}

                    fetch('/upload', {
                      method: 'PUT',
                      headers: {
                        'x-file-name': encodeURIComponent("{{ $.CurrentPath }}/Characters/" + uploader.dataset.target + extension(image.getMIME())),
                      },
                      body: buffer
                    }).then(function(response) {
                        if (response.ok) {
                            return response.json();
                        }
                        throw new Error('Network response was not ok.');
                    }).then(function(data) {
                        console.log(data);
                        uploader_cancel();
                    }).catch(function(error) {
                        console.log('There has been a problem with your fetch operation: ', error.message);
                    });
                });
            });
        });
    }

    document.addEventListener('dragstart', function (event) {
        event.dataTransfer.setData('text/plain', event.target.id);
        event.dataTransfer.dropEffect = 'copy';
    });

    document.addEventListener('dragover', function (event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'copy';
    });

    document.addEventListener('drop', function (event) {
        event.preventDefault();

        var target = event.target;
        target = target.nextElementSibling;

        uploader_target.innerText = target.innerText;
        uploader.dataset.target = target.innerText;

        backdrop.style.display = 'block';
        uploader.style.display = 'flex';

        opts = {
            viewport: {
                type: "circle",
                width: 400,
                height: 400
            }
        }
        c = new Croppie(uploader_preview, opts);

        var reader = new FileReader();
        reader.onload = function(e) {
            c.bind({
                url: e.target.result
            });
        }

        if (event.dataTransfer.files.length > 0) {
            reader.readAsDataURL(event.dataTransfer.files[0]);
        } else if (event.dataTransfer.items.length > 0) {
            var link = event.dataTransfer.getData('text/x-moz-url');

            if (link.match(/src="([^"]*)"/)) {
                // parse <img src ...> from link
                link = link.match(/src="([^"]*)"/)[1];
            }

            if (link) {
                request = new XMLHttpRequest();
                request.open('GET', "/get?url="+encodeURIComponent(link));
                request.responseType = 'blob';
                request.onload = function() {
                    reader.readAsDataURL(request.response);
                };
                request.send();
            }
        }
    });

    const hasRun = true;
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jimp@0.6.4/browser/lib/jimp.min.js"></script>
</body>
</html>
